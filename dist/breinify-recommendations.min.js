(()=>{var h,t;"object"!=typeof Breinify||Breinify.plugins._isAdded("recommendations")||(h=Breinify.UTL._jquery(),t=Breinify.plugins._overload(),Breinify.plugins._add("recommendations",{get:function(){t.overload({"String,Number,Function":function(t,e,n){this._retrieveRecommendations([t],{},e,{},n)},"Array,Number,Function":function(t,e,n){this._retrieveRecommendations(t,{},e,{},n)},"String,Number,Object,Function":function(t,e,n,a){this._retrieveRecommendations([t],{},e,n,a)},"Array,Number,Object,Function":function(t,e,n,a){this._retrieveRecommendations(t,{},e,n,a)},"String,Object,Number,Function":function(t,e,n,a){this._retrieveRecommendations([t],e,n,{},a)},"Array,Object,Number,Function":function(t,e,n,a){this._retrieveRecommendations(t,e,n,{},a)},"String,Object,Number,Object,Function":function(t,e,n,a,i){this._retrieveRecommendations([t],e,n,a,i)},"Array,Object,Number,Object,Function":function(t,e,n,a,i){this._retrieveRecommendations(t,e,n,a,i)}},arguments,this)},_retrieveRecommendations:function(t,e,n,a,i){var r=this,e=this._createUser(e,a),o=this._createRecommendations(t,n);h.isPlainObject(o)&&h.isArray(o.payload)&&0!==o.payload.length?Breinify.recommendation(e,o.payload,function(t,e){"string"==typeof e?i(new Error(e)):h.isArray(t.results)?(e=r._mapResults(o,t.results),e=r._applyRecommendationSettings(n,o,e),i(null,e)):i(new Error("Invalid response received."))}):i(null,{})},_getSettings:function(t){t=this.getConfig("recommendationSettings",{})[t];return h.isPlainObject(t)?t:{}},_getPayload:function(t){t=this.getConfig("recommendationPayloads",{})[t];return h.isPlainObject(t)?t:{}},_applyRecommendationSettings:function(t,e,n){for(var a={},i=[],r=0;r<e.recommendationIds.length;r++){for(var o=e.recommendationIds[r],d=this._getSettings(o),s=d.filter,c="boolean"!=typeof d.removeDuplicates||d.removeDuplicates,l=h.isArray(d.recommendationPayloadId)?d.recommendationPayloadId:[d.recommendationPayloadId],m=[],u=[],y=0;y<l.length&&u.length<t;y++){var p=n[l[y]],p=this._applyRecommendationPayload(p,s,m);c&&(p=this._removeUsedProducts(i,p)),u=u.concat(p).slice(0,t)}for(var f=0;f<u.length;f++)i.push(u[f].dataIdExternal);a[o]=u}return a},_applyRecommendationPayload:function(t,e,n){if(!h.isArray(t))return[];t=this._removeUsedProducts(n,t),h.isFunction(e)&&(t=e(t));for(var a=0;a<t.length;a++)n.push(t[a].dataIdExternal);return t},_removeUsedProducts:function(t,e){if(!h.isArray(e))return[];for(var n=[],a=0;a<e.length;a++){var i=e[a];-1===h.inArray(i.dataIdExternal,t)&&n.push(i)}return n},_createRecommendations:function(t,e){var n={payload:[],recommendationsPayloadIds:[],payloadIdToRecommendationIds:{},recommendationIds:{}};if(h.isArray(t)){for(var a=[],i={},r=[],o=0;o<t.length;o++){var d=t[o],s=this._getSettings(d);if(h.isPlainObject(s))for(var c=h.isArray(s.recommendationPayloadId)?s.recommendationPayloadId:[s.recommendationPayloadId],l=0;l<c.length;l++){var m=c[l],u=(-1===h.inArray(m,a)&&a.push(m),i[m]);h.isArray(u)||(i[m]=u=[]),-1===h.inArray(d,u)&&u.push(d),-1===h.inArray(d,r)&&r.push(d)}}if(0!==a.length){for(var y=0;y<a.length;y++){var p,f=a[y],g=this._getPayload(f);h.isPlainObject(g)&&(p="number"==typeof(p=(g=h.extend({},g)).multiplier)?Math.max(p,1):1,g.numRecommendations=p*e,n.recommendationsPayloadIds.push(f),n.payload.push(g))}n.payloadIdToRecommendationIds=i,n.recommendationIds=r}}return n},_createUser:function(t,e){var n={additional:{}};return h.isPlainObject(t)&&(n.userId="string"==typeof t.userId&&""!==t.userId.trim()?t.userId:null,n.email="string"==typeof t.email&&""!==t.email.trim()?t.email.toLowerCase():null),h.isPlainObject(e)&&(n.additional.location={storeId:"string"==typeof e.storeId&&""!==e.storeId.trim()?e.storeId:null}),n},_mapResults:function(t,e){for(var n={},a=0;a<e.length;a++){var i=e[a].result,r=h.isPlainObject(e[a].additionalData)?e[a].additionalData:{},o=[];if(h.isArray(i))for(var d=0;d<i.length;d++){var s=this._mapProduct(i[d],c,r);h.isPlainObject(s)&&o.push(s)}var c=t.recommendationsPayloadIds[a];n[c]=o}return n},_mapProduct:function(t,e,n){return h.isPlainObject(t)&&"string"==typeof t.dataIdExternal&&h.isPlainObject(t.additionalData)?this.getConfig("mapProduct",function(t,e){return{dataIdExternal:t.dataIdExternal,sku:t.dataIdExternal,inventory:t.additionalData["inventory::inventoryQuantity"],price:t.additionalData["inventory::productPrice"],name:t.additionalData["product::productName"],url:t.additionalData["product::productUrl"],image:t.additionalData["product::productImageUrl"],description:t.additionalData["product::productDescription"],additionalData:e}})(t,e,n):null}}))})();