"use strict";!function(){if("object"==typeof Breinify){var a=Breinify.UTL._jquery(),b=Breinify.plugins._overload(),c=(Breinify.UTL.constants.errors.prefix.validation,Breinify.UTL.constants.errors.prefix.api,{get:function(){b.overload({"String,Number,Function":function(a,b,c){this._retrieveRecommendations([a],{},b,{},c)},"Array,Number,Function":function(a,b,c){this._retrieveRecommendations(a,{},b,{},c)},"String,Number,Object,Function":function(a,b,c,d){this._retrieveRecommendations([a],{},b,c,d)},"Array,Number,Object,Function":function(a,b,c,d){this._retrieveRecommendations(a,{},b,c,d)},"String,Object,Number,Function":function(a,b,c,d){this._retrieveRecommendations([a],b,c,{},d)},"Array,Object,Number,Function":function(a,b,c,d){this._retrieveRecommendations(a,b,c,{},d)},"String,Object,Number,Object,Function":function(a,b,c,d,e){this._retrieveRecommendations([a],b,c,d,e)},"Array,Object,Number,Object,Function":function(a,b,c,d,e){this._retrieveRecommendations(a,b,c,d,e)}},arguments,this)},_retrieveRecommendations:function(b,c,d,e,f){var g=this,h=this._createUser(c,e),i=this._createRecommendations(b,d);return a.isPlainObject(i)&&a.isArray(i.payload)&&0!==i.payload.length?void Breinify.recommendation(h,i.payload,function(b,c){if("string"==typeof c)f(new Error(c));else if(a.isArray(b.results)){var e=g._mapResults(i,b.results);e=g._applyRecommendationSettings(d,i,e),f(null,e)}else f(new Error("Invalid response received."))}):void f(null,{})},_getSettings:function(b){var c=this.getConfig("recommendationSettings",{}),d=c[b];return a.isPlainObject(d)?d:{}},_getPayload:function(b){var c=this.getConfig("recommendationPayloads",{}),d=c[b];return a.isPlainObject(d)?d:{}},_applyRecommendationSettings:function(b,c,d){for(var e={},f=[],g=0;g<c.recommendationIds.length;g++){for(var h=c.recommendationIds[g],i=this._getSettings(h),j=i.filter,k="boolean"!=typeof i.removeDuplicates||i.removeDuplicates,l=a.isArray(i.recommendationPayloadId)?i.recommendationPayloadId:[i.recommendationPayloadId],m=[],n=[],o=0;o<l.length&&n.length<b;o++){var p=d[l[o]],q=this._applyRecommendationPayload(p,j,m);k&&(q=this._removeUsedProducts(f,q)),n=n.concat(q).slice(0,b)}for(var r=0;r<n.length;r++)f.push(n[r].dataIdExternal);e[h]=n}return e},_applyRecommendationPayload:function(b,c,d){if(!a.isArray(b))return[];b=this._removeUsedProducts(d,b),a.isFunction(c)&&(b=c(b));for(var e=0;e<b.length;e++)d.push(b[e].dataIdExternal);return b},_removeUsedProducts:function(b,c){if(!a.isArray(c))return[];for(var d=[],e=0;e<c.length;e++){var f=c[e];a.inArray(f.dataIdExternal,b)===-1&&d.push(f)}return d},_createRecommendations:function(b,c){var d={payload:[],recommendationsPayloadIds:[],payloadIdToRecommendationIds:{},recommendationIds:{}};if(!a.isArray(b))return d;for(var e=[],f={},g=[],h=0;h<b.length;h++){var i=b[h],j=this._getSettings(i);if(a.isPlainObject(j)){var k=j.recommendationPayloadId;a.inArray(k,e)===-1&&e.push(k);var l=f[k];a.isArray(l)||(l=[],f[k]=l),a.inArray(i,l)===-1&&l.push(i),a.inArray(i,g)===-1&&g.push(i)}}if(0===e.length)return d;for(var m=0;m<e.length;m++){var n=e[m],o=this._getPayload(n);if(a.isPlainObject(o)){o=a.extend({},o);var p=o.multiplier;p="number"==typeof p?Math.max(p,1):1,o.numRecommendations=p*c,d.recommendationsPayloadIds.push(n),d.payload.push(o)}}return d.payloadIdToRecommendationIds=f,d.recommendationIds=g,d},_createUser:function(b,c){var d={additional:{}};return a.isPlainObject(b)&&(d.userId="string"==typeof b.userId&&""!==b.userId.trim()?b.userId:null,d.email="string"==typeof b.email&&""!==b.email.trim()?b.email.toLowerCase():null),a.isPlainObject(c)&&(d.additional.location={storeId:"string"==typeof c.storeId&&""!==c.storeId.trim()?c.storeId:null}),d},_mapResults:function(b,c){for(var d={},e=0;e<c.length;e++){var f=c[e].result,g=[];if(a.isArray(f))for(var h=0;h<f.length;h++){var i=this._mapProduct(f[h]);a.isPlainObject(i)&&g.push(i)}var j=b.recommendationsPayloadIds[e];d[j]=g}return d},_mapProduct:function(b){if(!a.isPlainObject(b)||"string"!=typeof b.dataIdExternal)return null;if(!a.isPlainObject(b.additionalData))return null;var c=this.getConfig("mapProduct",function(a){return{dataIdExternal:a.dataIdExternal,sku:a.dataIdExternal,inventory:a.additionalData["inventory::inventoryQuantity"],price:a.additionalData["inventory::productPrice"],name:a.additionalData["product::productName"],url:a.additionalData["product::productUrl"],image:a.additionalData["product::productImageUrl"],description:a.additionalData["product::productDescription"]}});return c(b)}});Breinify.plugins._add("recommendations",c)}}();