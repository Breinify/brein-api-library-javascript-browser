"use strict";!function(){var h,t;"object"==typeof Breinify&&(Breinify.plugins._isAdded("recommendations")||(h=Breinify.UTL._jquery(),t=Breinify.plugins._overload(),Breinify.UTL.constants.errors.prefix.validation,Breinify.UTL.constants.errors.prefix.api,Breinify.plugins._add("recommendations",{get:function(){t.overload({"String,Number,Function":function(t,e,n){this._retrieveRecommendations([t],{},e,{},n)},"Array,Number,Function":function(t,e,n){this._retrieveRecommendations(t,{},e,{},n)},"String,Number,Object,Function":function(t,e,n,r){this._retrieveRecommendations([t],{},e,n,r)},"Array,Number,Object,Function":function(t,e,n,r){this._retrieveRecommendations(t,{},e,n,r)},"String,Object,Number,Function":function(t,e,n,r){this._retrieveRecommendations([t],e,n,{},r)},"Array,Object,Number,Function":function(t,e,n,r){this._retrieveRecommendations(t,e,n,{},r)},"String,Object,Number,Object,Function":function(t,e,n,r,i){this._retrieveRecommendations([t],e,n,r,i)},"Array,Object,Number,Object,Function":function(t,e,n,r,i){this._retrieveRecommendations(t,e,n,r,i)}},arguments,this)},_retrieveRecommendations:function(t,e,n,r,i){var a=this,e=this._createUser(e,r),o=this._createRecommendations(t,n);h.isPlainObject(o)&&h.isArray(o.payload)&&0!==o.payload.length?Breinify.recommendation(e,o.payload,function(t,e){"string"==typeof e?i(new Error(e)):h.isArray(t.results)?(e=a._mapResults(o,t.results),e=a._applyRecommendationSettings(n,o,e),i(null,e)):i(new Error("Invalid response received."))}):i(null,{})},_getSettings:function(t){t=this.getConfig("recommendationSettings",{})[t];return h.isPlainObject(t)?t:{}},_getPayload:function(t){t=this.getConfig("recommendationPayloads",{})[t];return h.isPlainObject(t)?t:{}},_applyRecommendationSettings:function(t,e,l){for(var n={},r=[],i=0;i<e.recommendationIds.length;i++){for(var m=e.recommendationIds[i],a=this._getSettings(m),u=a.filter,y="boolean"!=typeof a.removeDuplicates||a.removeDuplicates,f=h.isArray(a.recommendationPayloadId)?a.recommendationPayloadId:[a.recommendationPayloadId],p=[],o=[],d=0;d<f.length&&o.length<t;d++){var s=l[f[d]],s=this._applyRecommendationPayload(s,u,p);y&&(s=this._removeUsedProducts(r,s)),o=o.concat(s).slice(0,t)}for(var c=0;c<o.length;c++)r.push(o[c].dataIdExternal);n[m]=o}return n},_applyRecommendationPayload:function(t,e,n){if(!h.isArray(t))return[];t=this._removeUsedProducts(n,t),h.isFunction(e)&&(t=e(t));for(var r=0;r<t.length;r++)n.push(t[r].dataIdExternal);return t},_removeUsedProducts:function(t,e){if(!h.isArray(e))return[];for(var n=[],r=0;r<e.length;r++){var i=e[r];-1===h.inArray(i.dataIdExternal,t)&&n.push(i)}return n},_createRecommendations:function(t,l){var e={payload:[],recommendationsPayloadIds:[],payloadIdToRecommendationIds:{},recommendationIds:{}};if(!h.isArray(t))return e;for(var n=[],r={},m=[],u=0;u<t.length;u++){var i=t[u],a=this._getSettings(i);if(h.isPlainObject(a))for(var y=h.isArray(a.recommendationPayloadId)?a.recommendationPayloadId:[a.recommendationPayloadId],f=0;f<y.length;f++){var o=y[f],d=(-1===h.inArray(o,n)&&n.push(o),r[o]);h.isArray(d)||(r[o]=d=[]),-1===h.inArray(i,d)&&d.push(i),-1===h.inArray(i,m)&&m.push(i)}}if(0===n.length)return e;for(var p=0;p<n.length;p++){var s,g=n[p],c=this._getPayload(g);h.isPlainObject(c)&&(s="number"==typeof(s=(c=h.extend({},c)).multiplier)?Math.max(s,1):1,c.numRecommendations=s*l,e.recommendationsPayloadIds.push(g),e.payload.push(c))}return e.payloadIdToRecommendationIds=r,e.recommendationIds=m,e},_createUser:function(t,e){var n={additional:{}};return h.isPlainObject(t)&&(n.userId="string"==typeof t.userId&&""!==t.userId.trim()?t.userId:null,n.email="string"==typeof t.email&&""!==t.email.trim()?t.email.toLowerCase():null),h.isPlainObject(e)&&(n.additional.location={storeId:"string"==typeof e.storeId&&""!==e.storeId.trim()?e.storeId:null}),n},_mapResults:function(t,e){for(var n={},r=0;r<e.length;r++){var i=e[r].result,a=h.isPlainObject(e[r].additionalData)?e[r].additionalData:{},o=[];if(h.isArray(i))for(var d=0;d<i.length;d++){var s=this._mapProduct(i[d],c,a);h.isPlainObject(s)&&o.push(s)}var c=t.recommendationsPayloadIds[r];n[c]=o}return n},_mapProduct:function(t,e,n){return h.isPlainObject(t)&&"string"==typeof t.dataIdExternal&&h.isPlainObject(t.additionalData)?this.getConfig("mapProduct",function(t,e){return{dataIdExternal:t.dataIdExternal,sku:t.dataIdExternal,inventory:t.additionalData["inventory::inventoryQuantity"],price:t.additionalData["inventory::productPrice"],name:t.additionalData["product::productName"],url:t.additionalData["product::productUrl"],image:t.additionalData["product::productImageUrl"],description:t.additionalData["product::productDescription"],additionalData:e}})(t,e,n):null}})))}();