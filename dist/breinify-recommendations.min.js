(()=>{if("object"==typeof Breinify&&!Breinify.plugins._isAdded("recommendations")){let d=Breinify.UTL._jquery(),e=Breinify.plugins._overload(),r={recommender:null,splitTests:{control:{itemSelector:null,containerSelector:null}},position:{before:null,after:null,prepend:null,append:null,replace:null},placeholders:{"random::uuid":function(){return Breinify.UTL.uuid()}},templates:{container:null,item:null},process:{error:function(e){},init:function(e){},pre:function(e,t){},attachedItem:function(e,t,n,r){},attached:function(e,t,n,r){},post:function(e,t,n,r){}}},c={_process:function(e,...t){return!!d.isFunction(e)&&(e(...t),!0)},_determineSelector:function(e){return"string"==typeof(e=d.isFunction(e)?e():e)?d(e):e instanceof d?e:null},_appendContainer:function(e,t){if(!d.isPlainObject(e)||!d.isPlainObject(e.position))return null;let n=null,r=null;null!==e.position.before?(r=e.position.before,n="before"):null!==e.position.after?(r=options.position.after,n="after"):null!==e.position.append?(r=e.position.append,n="append"):null!==e.position.prepend?(r=e.position.prepend,n="prepend"):null!==e.position.replace&&(r=e.position.replace,n="replace");var i,a=this._determineSelector(r);return null===a||null===(i=this._determineSelector(e.templates.container))?null:(this._replacePlaceholders(i,t,e),d.isFunction(a[n])&&a[n](i),i)},_appendItems:function(r,e,i){let a=this,o=this._determineSelector(i.templates.item);if(null===o)return null;d.each(e.recommendations,function(e,t){var n=a._replacePlaceholders(o.clone(),t,i);r.append(n),c._process(i.process.attachedItem,r,n,t,i)})},_replacePlaceholders:function(r,i,a){let o=this;r.contents().filter(function(){return 3===this.nodeType}).each(function(){var e=d(this),t=o._replace(e.text(),i,a);null!==t&&e.replaceWith(t)});var e=r.get(0).attributes;return d.each(e,function(e,t){var n=o._replace(t.value,i,a);null!==n&&(t.name.startsWith("data-rename-")?(r.removeAttr(t.name),r.attr(t.name.replace("data-rename-",""),n)):r.attr(t.name,n))}),r.children().each(function(){o._replacePlaceholders(d(this),i,a)}),r},_replace:function(e,o,s){var c=this;if("string"!=typeof e||""===e.trim())return null;let l={_counter:0};e=e.replace(/%%([a-zA-Z][a-zA-Z0-9_]*(?:\.[a-zA-Z][a-zA-Z0-9_]*)*|[a-zA-Z][a-zA-Z0-9_-]*(?:::[a-zA-Z][a-zA-Z0-9_-]*)?)%%/g,function(e,t){var n=s.placeholders[t],r=d.isFunction(n)||"string"==typeof n,t=c._readPath(t,o),i=void 0!==t;let a;return null===(a=r?"string"===n?n:d.isFunction(n)?n.call(s.placeholders,o,i?t:null):null:i?t:null)?e:(l._counter++,a)});return 0<l._counter?e:null},_readPath:function(e,t){var n=e.split(".");if(1===n.length)return t[e];let r=t;for(let e=0;e<n.length;e++){if(!d.isPlainObject(r))return null;var i=n[e];r=r[i]}return r}};Breinify.plugins._add("recommendations",{render:function(){let s=this;e.overload({Array:function(t){let n={};var r=[];for(let e=0;e<t.length;e++){var i=this._preRenderRecommendations({temporary:t[e]}),a=i.temporary.recommender;if(!d.isPlainObject(a)||!d.isPlainObject(a.payload)||!d.isArray(a.payload.namedRecommendations))return void c._process(i.process.error,{code:-1,error:!0,message:"invalid payload for recommender defined for rendering process",options:i});var o=this._determineName(a.payload,e);n[o]=i.temporary,r.push(a.payload)}this._retrieveRecommendations(r,function(e,t){s._renderRecommendations(n,e,t)})},Object:function(e){s.render([e])},"Object,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations([e],function(e,t){s._renderRecommendations(n,e,t)})},"Array,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations(null,e,function(e,t){s._renderRecommendations(n,e,t)})},"String,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations([{namedRecommendations:[e]}],function(e,t){s._renderRecommendations(n,e,t)})},"String,Object,Object":function(e,t,n){let r=this._preRenderRecommendations(n);this._retrieveRecommendations([d.extend({namedRecommendations:[e]},t)],function(e,t){s._renderRecommendations(r,e,t)})}},arguments,this)},get:function(){e.overload({"Object,Function":function(e,t){this._retrieveRecommendations([e],t)},"Array,Function":function(e,t){this._retrieveRecommendations(null,e,t)},"String,Function":function(e,t){this._retrieveRecommendations([{namedRecommendations:[e]}],t)},"String,Object,Function":function(e,t,n){this._retrieveRecommendations([d.extend({namedRecommendations:[e]},t)],n)}},arguments,this)},_preRenderRecommendations:function(e){let n={};return d.each(e,function(e,t){t=d.extend(!0,{},r,t);c._process(t.process.init,t),n[e]=t}),n},_renderRecommendations:function(e,n,r){let i=this;null!==n?d.each(e,function(e,t){c._process(t.process.error,n)}):d.each(e,function(e,t){var n=r[e];d.isPlainObject(n)?!0===n.error?c._process(t.process.error,d.extend({name:e,result:n},n.status)):(!0!==n.splitTestData.isControl&&i._renderRecommendation(t,n),i._applyBindings(t,n)):c._process(t.process.error,{code:-1,error:!0,message:"unexpected result-type received",name:e,result:n})})},_applyBindings:function(e,t){!0===t.splitTestData.isControl&&(e.splitTests.control.itemSelector,e.splitTests.control.containerSelector)},_renderRecommendation:function(e,t){c._process(e.process.pre,t,e);var n=c._appendContainer(e,t);let r=n.find(".br-rec-item-container");0===r.length&&(r=n),c._appendItems(r,t,e),c._process(e.process.attached,n,r,t,e);var i=c._determineSelector(e.splitTests.control.containerSelector);null!==i&&i.hide(),c._process(e.process.post,n,r,t,e)},_retrieveRecommendations:function(n,r){let i=this;Breinify.recommendation({},n,function(e,t){"string"==typeof t?r(new Error(t)):d.isArray(e.results)?(t=i._mapResults(n,e.results),r(null,t)):r(new Error("Invalid response received."))})},_mapResults:function(n,r){var i={};for(let t=0;t<r.length;t++){var a=t<n.length&&d.isPlainObject(n[t])?n[t]:{},o=r[t],s={},o=(this._determineErrorResponse(o,s)||this._determineSplitTestData(o,s)||this._determineRecommendationData(o,s),this._determineAdditionalData(o,s),this._determineMetaData(o,s),this._determineName(a,t));let e;e="number"==typeof a.numRecommendations&&0<a.numRecommendations?a.numRecommendations:null,s.payload={name:o,expectedNumberOfRecommendations:e},i[o]=s}return i},_determineErrorResponse:function(e,t){return d.isPlainObject(e)?(200===e.statusCode||7120===e.statusCode?t.status={code:e.statusCode,message:e.message,error:!1}:t.status={error:!0,code:e.statusCode,message:e.message},t.status.error):(t.status={error:!0,code:500,message:"invalid result type received"},!0)},_determineRecommendationData:function(e,t){let n="com.brein.common.dto.CustomerProductDto";"com.brein.common.dto.CustomerProductDto"===(n=d.isPlainObject(e)&&d.isPlainObject(e._breinMetaData)&&"string"==typeof e._breinMetaData.dataType&&""!==e._breinMetaData.dataType.trim()?e._breinMetaData.dataType.trim():n)?t.recommendations=this._mapProducts(e):t.recommendations=this._mapAny(e)},_determineAdditionalData:function(e,n){d.isPlainObject(e)&&d.isPlainObject(e.additionalData)&&(n.additionalData={},d.each(e.additionalData,function(e,t){"_breinMetaData"!==e&&"splitTestData"!==e&&(n.additionalData[e]=t)}))},_determineName:function(e,t){return d.isPlainObject(e)&&d.isArray(e.namedRecommendations)&&1===e.namedRecommendations.length?e.namedRecommendations[0]:"response["+t+"]"},_determineMetaData:function(e,t){},_determineSplitTestData:function(e,t){return d.isPlainObject(e)&&d.isPlainObject(e.additionalData)&&d.isPlainObject(e.additionalData.splitTestData)?t.splitTestData=d.extend({active:!0,isTest:200===e.statusCode,isControl:7120===e.statusCode},e.additionalData.splitTestData):7120===t.statusCode?t.splitTestData={active:!0,isTest:!1,isControl:!1}:t.splitTestData={active:!1,isTest:!1,isControl:!1},t.active},_mapProducts:function(e){if(!d.isArray(e.result))return[];for(var t=[],n=0;n<e.result.length;n++){var r=e.result[n],r=this._mapProduct(r);t.push(r)}return t},_mapProduct:function(e){var t;return d.isPlainObject(e)&&"string"==typeof e.dataIdExternal&&d.isPlainObject(e.additionalData)?(t=null===(t=this._getValue(e,"inventory::productPrice"))?this._getValue(e,"product::productPrice"):t,{_recommenderWeight:e.weight,id:e.dataIdExternal,inventory:this._getValue(e,"inventory::inventoryQuantity"),name:this._getValue(e,"product::productName"),url:this._getValue(e,"product::productUrl"),image:this._getValue(e,"product::productImageUrl"),categories:this._getValue(e,"product::productCategories"),description:this._getValue(e,"product::productDescription"),price:t,additionalData:e.additionalData}):null},_mapAny:function(e){if(!d.isArray(e.result))return[];for(var t=[],n=0;n<e.result.length;n++){var r=e.result[n],r={_recommenderWeight:r.weight,id:r.dataIdExternal,additionalData:r.additionalData};t.push(r)}return t},_getValue:function(e,t){e=e.additionalData[t];return null==e?null:e}})}})();