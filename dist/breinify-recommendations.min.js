(()=>{if("object"==typeof Breinify&&!Breinify.plugins._isAdded("recommendations")){let u=Breinify.UTL._jquery(),e=Breinify.plugins._overload(),l={marker:{container:"brrc-cont",item:"brrc-item",data:"recommendation"},splitTest:{defaultGroup:"breinify",defaultGroupType:"none",defaultTestGroup:"breinify",defaultControlGroup:"control",testGroupType:"test",controlGroupType:"control"},_process:function(e,...t){return!!u.isFunction(e)&&(e(...t),!0)},_determineSelector:function(e,t){return"string"==typeof(e=u.isFunction(e)?e(t):e)?u(e):e instanceof u?e:null},_appendContainer:function(n,i,a){if(u.isPlainObject(n)&&u.isPlainObject(n.position)){let e=null,t=null;if(null!==n.position.before)t=n.position.before,e="before";else if(null!==n.position.after)t=n.position.after,e="after";else if(null!==n.position.append)t=n.position.append,e="append";else if(null!==n.position.prepend)t=n.position.prepend,e="prepend";else if(null!==n.position.replace)t=n.position.replace,e="replaceWith";else if(null!==n.position.externalRender)return void this._applyExternalRender(n,i,function(e){a(e,{error:!1,externalRendering:!0})});var r,o=this._determineSelector(t);null===o?a(null,{error:!0,errorDescription:"unable to find anchor",externalRendering:!1}):null===(r=this._determineSelector(n.templates.container))?a(null,{error:!0,errorDescription:"unable to find container",externalRendering:!1}):(this._replacePlaceholders(r,i,n),u.isFunction(o[e])?(o[e](r),a(r,{error:!1,externalRendering:!1})):a(null,{error:!0,errorDescription:"unable to apply method to anchor",externalRendering:!1}))}else a(null,{error:!0,errorDescription:"missing position",externalRendering:!1})},_applyExternalRender:function(e,t,n){u.isFunction(e.position.externalRender)?e.position.externalRender(t,n):n(null)},_appendItems:function(i,e,a){let r=this,o=this._determineSelector(a.templates.item,i);if(null===o)return null;u.each(e.recommendations,function(e,t){var n=r._replacePlaceholders(o.clone(!1),t,a);r._setupItemData(n,e,t),i.append(n),r._process(a.process.attachedItem,i,n,t,a)})},_isItem:function(e){return 1===e.closest("[data-"+this.marker.container+'="true"]').length},_setupItemData:function(e,t,n){t="number"==typeof t?t<0?t:t+1:null;e.addClass(this.marker.item).attr("data-"+this.marker.item,"true").data(this.marker.data,u.extend(!0,{widgetPosition:t},n))},_replacePlaceholders:function(t,n,i){let a=this;t.contents().filter(function(){return 3===this.nodeType}).each(function(){var e=u(this),t=a._replace(e.text(),n,i);null!==t&&e.replaceWith(t)});var r=t.get(0).attributes;for(let e=0;e<r.length;e++){var o=r[e],s=a._replace(o.value,n,i);null!==s&&(o.name.startsWith("data-rename-")?(t.removeAttr(o.name),t.attr(o.name.replace("data-rename-",""),s)):t.attr(o.name,s))}return t.children().each(function(){a._replacePlaceholders(u(this),n,i)}),t},_replace:function(e,s,l){let c=this;if("string"!=typeof e||""===e.trim())return null;let d={_counter:0};e=e.replace(/%%([a-zA-Z][a-zA-Z0-9_]*(?:\.[a-zA-Z](?:(?:::)?[a-zA-Z0-9_])*)*|[a-zA-Z][a-zA-Z0-9_-]*(?:::[a-zA-Z][a-zA-Z0-9_-]*)?)%%/g,function(e,t){var n=l.placeholders[t],i=u.isFunction(n)||"string"==typeof n,a=c._readPath(t,s),r=void 0!==a;let o;return null===(o=null===(o=i?"string"==typeof n?n:u.isFunction(n)?n.call(l.placeholders,s,r?a:null):null:r?a:null)&&u.isFunction(l.placeholderSettings.replaceWith)?l.placeholderSettings.replaceWith(t):o)?e:(d._counter++,o)});return 0<d._counter?e:null},_readPath:function(e,t){var n=e.split(".");if(1===n.length)return t[e];let i=t;for(let e=0;e<n.length;e++){if(!u.isPlainObject(i))return null;var a=n[e];i=i[a]}return i}},o={recommender:null,activity:{type:"clickedRecommendation"},bindings:{selector:"a",specificSelectors:{}},splitTests:{control:{containerSelector:null}},position:{before:null,after:null,prepend:null,append:null,replace:null,externalRender:null},placeholderSettings:{replaceWith:function(e){return""}},placeholders:{"random::uuid":function(){return Breinify.UTL.uuid()},"marker::container":l.marker.container,"marker::item":l.marker.item},templates:{container:null,item:null},process:{stoppedPropagation:function(e){},error:function(e){},init:function(e){},pre:function(e,t){},attachedContainer:function(e,t,n,i){},attachedItem:function(e,t,n,i){},attached:function(e,t,n,i){},post:function(e,t,n,i){},finalize:function(e,t,n){},clickedItem:function(e,t){},createActivity:function(e,t){}},data:{modify:function(e,t){return null}}};var t={marker:u.extend(!0,{},l.marker),bind:function(){let r=this;e.overload({Object:function(e){e=u.extend(!0,{},o,e);r._bindContainer(e)},"Object,Object":function(i,e){let a=u.extend(!0,{},o,e);r._loadSplitTestSeparately(i,function(e,t){var n=u.isPlainObject(a.recommender)&&u.isPlainObject(a.recommender.payload)?a.recommender.payload:{};if(null===e){let e=200;u.isArray(i.controlGroups)&&u.isPlainObject(t.splitTestData)&&-1<u.inArray(t.splitTestData.groupDecision,i.controlGroups)&&(e=7120),r._bindContainer(a,r._mapResult(n,{additionalData:{splitTestData:t.splitTestData},statusCode:e}))}else{t=r._mapResult(n,{statusCode:400,message:e instanceof Error?e.message:null});l._process(a.process.error,u.extend({name:i.name,result:t},t.status))}})}},arguments,this)},render:function(){let s=this;e.overload({Array:function(t){let n={};var i=[];for(let e=0;e<t.length;e++){var a=this._preRenderRecommendations({temporary:t[e]}),r=a.temporary.recommender;if(!u.isPlainObject(r)||!u.isPlainObject(r.payload)||!u.isArray(r.payload.namedRecommendations))return void l._process(a.process.error,{code:-1,error:!0,message:"invalid payload for recommender defined for rendering process",options:a});var o=this._determineName(r.payload,e,t);n[o]=a.temporary,i.push(r.payload)}this._retrieveRecommendations(i,function(e,t){s._renderRecommendations(n,e,t)})},Object:function(e){s.render([e])},"Object,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations([e],function(e,t){s._renderRecommendations(n,e,t)})},"Array,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations(e,function(e,t){s._renderRecommendations(n,e,t)})},"String,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations([{namedRecommendations:[e]}],function(e,t){s._renderRecommendations(n,e,t)})},"String,Object,Object":function(e,t,n){let i=this._preRenderRecommendations(n);this._retrieveRecommendations([u.extend({namedRecommendations:[e]},t)],function(e,t){s._renderRecommendations(i,e,t)})}},arguments,this)},get:function(){e.overload({"Object,Function":function(e,t){this._retrieveRecommendations([e],t)},"Array,Function":function(e,t){this._retrieveRecommendations(e,t)},"String,Function":function(e,t){this._retrieveRecommendations([{namedRecommendations:[e]}],t)},"String,Object,Function":function(e,t,n){this._retrieveRecommendations([u.extend({namedRecommendations:[e]},t)],n)}},arguments,this)},setRecommendationData:function(e,t,n){return!!l._isItem(e)&&(l._setupItemData(e,t,n),!0)},_loadSplitTestSeparately:function(e,n){var t,i,a;!1===Breinify.plugins._isAdded("splitTests")?n(new Error("please ensure that the split-tests plugin is available when using this feature.")):(t=e.name,i=null===Breinify.UTL.isNonEmptyString(e.token)?e.tokens:e.token,a=null===Breinify.UTL.isNonEmptyString(e.storageKey)?e.storageKeys:e.storageKey,e=u.extend(!0,{splitTestName:e.name},e.payload),Breinify.plugins.splitTests.retrieveSplitTest(t,i,e,a,function(e,t){n(e,t)}))},_bindContainer:function(e,t){let n=this;var t=u.isPlainObject(t)?t:{},i=l._determineSelector(e.templates.container),t=(this._setupContainer(i,e,t),this._applyBindings(e,i),l._determineSelector(e.templates.item,i));null!==t&&t.each(function(e){n.setRecommendationData(u(this),e,{})})},_preRenderRecommendations:function(e){let n={};return u.each(e,function(e,t){t=u.extend(!0,{},o,t);l._process(t.process.init,t),n[e]=t}),n},_renderRecommendations:function(e,n,t){let r=this;null!==n?u.each(e,function(e,t){l._process(t.process.error,n)}):u.each(e,function(e,i){let a=t[e];if(u.isPlainObject(a)&&u.isPlainObject(a.status))if(!0===a.status.error)l._process(i.process.error,u.extend({name:e,result:a},a.status));else if(u.isFunction(i.data.modify)){let t=function(t){u.isArray(t)||(t=u.isPlainObject(t)&&u.isPlainObject(t.result)&&u.isPlainObject(t.option)?[t]:[{result:a,option:i}]);for(let e=0;e<t.length;e++){var n=t[e];r._applyRecommendation(n.result,n.option)}};var n=i.data.modify(a,i);u.isFunction(i.data.modify.constructor)&&"AsyncFunction"===i.data.modify.constructor.name&&window.Promise&&n instanceof window.Promise?n.then(e=>t(e)).catch(e=>l._process(i.process.error,{code:-1,error:!0,message:e.message,name:e.name,result:e})):t(n)}else r._applyRecommendation(a,i);else l._process(i.process.error,{code:-1,error:!0,message:"unexpected result-type received",name:e,result:a})})},_applyRecommendation:function(t,n){let i=this;var e;!0===t.splitTestData.isControl?(e=i._setupControlContainer(n,t),this._applyBindings(n,e),l._process(n.process.finalize,n,t,e)):7120===t.status.code?l._process(n.process.finalize,n,t,null):this._renderRecommendation(n,t,function(e){i._applyBindings(n,e),l._process(n.process.finalize,n,t,e)})},_handleClick:function(e,t,n,i){var a,r=t.closest("."+l.marker.container);1===r.length&&(a=r.data(l.marker.data),u.isPlainObject(a))&&u.isPlainObject(a.option)&&u.isPlainObject(a.data)&&(!0===a.data.splitTestData.isControl?this._handleControlClick(n,t,r,a.data,i,a.option):this._handleRecommendationClick(n,t,r,a.data,i,a.option),!0===i.stopPropagation)&&(n.stopPropagation(),l._process(e.process.stoppedPropagation,n,t,r,a.data,i,a.option))},_handleRecommendationClick:function(e,t,n,i,a,r){var o,t=t.closest("."+l.marker.item);1===t.length&&(o=t.data(l.marker.data),u.isPlainObject(o))&&(t={isControl:!1,$recItem:t,$recContainer:n,additionalEventData:a,recommendationData:i,recommendation:o},l._process(r.process.clickedItem,e,t),n=this._createDefaultTags(i,a),this._applyBreinifyTags(n,i,o,a),t.activityTags=n,this._sendActivity(r,e,t))},_handleControlClick:function(e,t,n,i,a,r){n={isControl:!0,$controlItem:t,$controlContainer:n,additionalEventData:a,recommendationData:i},l._process(r.process.clickedItem,e,n),n.activityTags=this._createDefaultTags(i,a),t=t.closest("."+l.marker.item),t=1===t.length?t.data(l.marker.data):null;u.isPlainObject(t)&&this._applyBreinifyTags(n.activityTags,i,t,a),this._sendActivity(r,e,n)},_applyBreinifyTags:function(e,t,n,i){"number"==typeof n.widgetPosition&&(e.widgetPosition=n.widgetPosition,"string"==typeof e.widgetType)&&(e.widgetId=e.widgetType+"-"+e.widgetPosition),"string"==typeof n.id&&(e.productIds=[],e.productIds.push(n.id))},_createDefaultTags:function(e,t){var n={},i=u.isPlainObject(e.splitTestData)?e.splitTestData:{active:!1};let a,r;r=!1===i.active?(a=l.splitTest.defaultGroupType,l.splitTest.defaultGroup):!0===i.isControl?(a=l.splitTest.controlGroupType,"string"==typeof i.groupDecision&&""!==i.groupDecision.trim()?i.groupDecision:l.splitTest.defaultControlGroup):(a=l.splitTest.testGroupType,"string"==typeof i.groupDecision&&""!==i.groupDecision.trim()?i.groupDecision:l.splitTest.defaultTestGroup);var o="string"==typeof i.testName&&""!==i.testName.trim()?i.testName:null,i="string"==typeof i.selectedInstance&&""!==i.selectedInstance.trim()?i.selectedInstance:null,o=(n.group=r,n.groupType=a,n.splitTest=null===o?null:o+(null===i?"":" ("+i+")"),u.isPlainObject(e.payload)?e.payload:{}),i="string"==typeof o.queryName&&""!==o.queryName.trim()?o.queryName:null,e="string"==typeof o.recommenderName&&""!==o.recommenderName.trim()?o.recommenderName:null;return n.widgetType=e,n.widgetLabel=null===i?e:i,n},_sendActivity:function(e,t,n){var i=t.metaKey||t.ctrlKey||2===t.which,a=t.target instanceof HTMLAnchorElement,r=e.activity.type;if(n=u.extend(!0,{additionalEventData:{meta:{openInNewTab:i,willReloadPage:a},sendActivities:!0,scheduleActivities:null},activityType:r,activityTags:{},activityUser:{}},n),l._process(e.process.createActivity,t,n),!1!==n.additionalEventData.sendActivities){"number"==typeof n.activityTags.widgetPosition&&"string"==typeof n.activityTags.widgetType&&"string"!=typeof n.activityTags.widgetId&&(n.activityTags.widgetId=n.activityTags.widgetType+"-"+n.activityTags.widgetPosition);let e=null;null===n.additionalEventData.scheduleActivities?e=!1!=a&&!0!==i:"boolean"==typeof n.additionalEventData.scheduleActivities&&(e=n.additionalEventData.scheduleActivities),u.isPlainObject(Breinify.plugins.activities)&&(!0===e?Breinify.plugins.activities.scheduleDelayedActivity(n.activityUser,n.activityType,n.activityTags,6e4):!1===e&&Breinify.plugins.activities.generic(n.activityType,n.activityUser,n.activityTags))}},_applyBindings:function(n,i){let a=this;Breinify.UTL.dom.addClickObserver(n.bindings.selector,"clickedRecommendations",function(e,t){a._handleClick(n,u(this),e,t)});var r=n.bindings.specificSelectors;if(u.isPlainObject(r)&&null!==i){var o=Object.keys(r);for(let e=0;e<o.length;e++){var s=o[e],l=r[s];let t=u.isPlainObject(l)?l:{};i.find(s).on("click",function(e){a._handleClick(n,u(this),e,t)})}}},_setupControlContainer:function(e,t){var n=l._determineSelector(e.splitTests.control.containerSelector);return null===n?null:this._setupContainer(n,e,t)},_setupContainer:function(e,t,n){return e.hasClass(l.marker.container)||e.addClass(l.marker.container),e.attr("data-"+l.marker.container,"true").data(l.marker.data,{option:t,data:n})},_renderRecommendation:function(a,r,o){let s=this;l._process(a.process.pre,r,a),l._appendContainer(a,r,function(e,t){if(null===e||!0===t.error)o(null,t);else{let i=e.find("."+l.marker.container);0===i.length&&(i=e).addClass(l.marker.container),i=s._setupContainer(i,a,r),l._process(a.process.attachedContainer,e,i,r,a),!0===t.externalRendering?u.each(r.recommendations,function(e,t){var n=i.children().eq(e);l._setupItemData(n,e,t)}):(l._appendItems(i,r,a),l._process(a.process.attached,e,i,r,a));var n=l._determineSelector(a.splitTests.control.containerSelector);null!==n&&1===n.length&&n.get(0)!==e.get(0)&&0===n.find(".brrc-item").length&&n.hide(),l._process(a.process.post,e,i,r,a),o(e,t)}})},_retrieveRecommendations:function(n,i){let a=this;Breinify.recommendation({},n,function(e,t){"string"==typeof t?i(new Error(t)):u.isArray(e.results)?(t=a._mapResults(n,e.results),i(null,t)):i(new Error("Invalid response received."))})},_mapResult:function(e,t){var n={};this._determineErrorResponse(t,n)||this._determineSplitTestData(t,n)||this._determineRecommendationData(t,n),this._determineAdditionalData(t,n),this._determineMetaData(t,n);let i=null,a=("number"==typeof e.numRecommendations&&0<e.numRecommendations&&(i=e.numRecommendations),null),r=("string"==typeof e.recommendationQueryName&&""!==e.recommendationQueryName.trim()&&(a=e.recommendationQueryName),null);u.isPlainObject(e)&&u.isArray(e.namedRecommendations)&&1===e.namedRecommendations.length&&(r=e.namedRecommendations[0]);t=u.isArray(e.recommendationForItems)&&0<e.recommendationForItems.length;return n.payload={recommenderName:r,queryName:a,isForItems:t,expectedNumberOfRecommendations:i},n},_mapResults:function(t,n){var i={};for(let e=0;e<n.length;e++){var a=e<t.length&&u.isPlainObject(t[e])?t[e]:{},r=n[e],r=this._mapResult(a,r),a=(u.isPlainObject(r.payload)||(r.payload={}),this._determineName(a,e,t));i[r.payload.name=a]=r}return i},_determineErrorResponse:function(e,t){return u.isPlainObject(e)?(200===e.statusCode||7120===e.statusCode?t.status={code:e.statusCode,message:e.message,error:!1}:t.status={error:!0,code:e.statusCode,message:e.message},t.status.error):(t.status={error:!0,code:500,message:"invalid result type received"},!0)},_determineRecommendationType:function(e){let t="com.brein.common.dto.CustomerProductDto";return t=u.isPlainObject(e)&&u.isPlainObject(e._breinMetaData)&&"string"==typeof e._breinMetaData.dataType&&""!==e._breinMetaData.dataType.trim()?e._breinMetaData.dataType.trim():t},_determineRecommendationData:function(e,t){var n=this._determineRecommendationType(e);t.recommendations="com.brein.common.dto.CustomerProductDto"===n?this._mapProducts(e):this._mapAny(e)},_determineAdditionalData:function(e,n){u.isPlainObject(e)&&u.isPlainObject(e.additionalData)&&(n.additionalData={},u.each(e.additionalData,function(e,t){"_breinMetaData"!==e&&"splitTestData"!==e&&(n.additionalData[e]=t)}))},_determineName:function(e,t,n){e=this._extractCandidateNameFromPayload(e);return null===e?"response["+t+"]":"number"==typeof(n=this._extractCandidateNamesFromPayloads(n)[e])&&1<n?e+"["+t+"]":e},_extractCandidateNamesFromPayloads:function(t){var n={};if(u.isArray(t))for(let e=0;e<t.length;e++){var i=u.isPlainObject(t[e])&&u.isPlainObject(t[e].recommender)&&u.isPlainObject(t[e].recommender.payload)?t[e].recommender.payload:t[e],i=this._extractCandidateNameFromPayload(i);null!==i&&(n[i]="number"==typeof n[i]?n[i]+1:1)}return n},_extractCandidateNameFromPayload:function(e){return u.isPlainObject(e)&&u.isArray(e.namedRecommendations)&&1===e.namedRecommendations.length?e.namedRecommendations[0]:null},_determineMetaData:function(e,t){t.meta={},t.meta.type=this._determineRecommendationType(e)},_determineSplitTestData:function(e,t){return u.isPlainObject(e)&&u.isPlainObject(e.additionalData)&&u.isPlainObject(e.additionalData.splitTestData)?t.splitTestData=u.extend({active:!0,isTest:200===e.statusCode,isControl:7120===e.statusCode},e.additionalData.splitTestData):7120===e.statusCode?t.splitTestData={active:!0,isTest:!1,isControl:!1}:t.splitTestData={active:!1,isTest:!1,isControl:!1},t.active},_mapProducts:function(t){if(!u.isArray(t.result))return[];var n=[];for(let e=0;e<t.result.length;e++){var i=t.result[e],i=this._mapProduct(i);n.push(i)}return n},_mapProduct:function(e){var t;return u.isPlainObject(e)&&"string"==typeof e.dataIdExternal&&u.isPlainObject(e.additionalData)?(t=null===(t=this._getValue(e,"inventory::productPrice"))?this._getValue(e,"product::productPrice"):t,{_recommenderWeight:e.weight,id:e.dataIdExternal,inventory:this._getValue(e,"inventory::inventoryQuantity"),name:this._getValue(e,"product::productName"),url:this._getValue(e,"product::productUrl"),image:this._getValue(e,"product::productImageUrl"),categories:this._getValue(e,"product::productCategories"),description:this._getValue(e,"product::productDescription"),price:t,additionalData:e.additionalData}):null},_mapAny:function(t){if(!u.isArray(t.result))return[];var n=[];for(let e=0;e<t.result.length;e++){var i=t.result[e],i={_recommenderWeight:i.weight,id:i.dataIdExternal,additionalData:i.additionalData};n.push(i)}return n},_getValue:function(e,t){e=e.additionalData[t];return null==e?null:e}};Breinify.plugins._add("recommendations",t)}})();