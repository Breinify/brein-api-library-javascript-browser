(()=>{if("object"==typeof Breinify&&!Breinify.plugins._isAdded("recommendations")){let u=Breinify.UTL._jquery(),e=Breinify.plugins._overload(),l={marker:{container:"brrc-cont",item:"brrc-item",data:"recommendation"},splitTest:{defaultGroup:"breinify",defaultGroupType:"none",defaultTestGroup:"breinify",defaultControlGroup:"control",testGroupType:"test",controlGroupType:"control"},_process:function(e,...t){return!!u.isFunction(e)&&(e(...t),!0)},_determineSelector:function(e){return"string"==typeof(e=u.isFunction(e)?e():e)?u(e):e instanceof u?e:null},_appendContainer:function(n,i,r){if(u.isPlainObject(n)&&u.isPlainObject(n.position)){let e=null,t=null;if(null!==n.position.before)t=n.position.before,e="before";else if(null!==n.position.after)t=n.position.after,e="after";else if(null!==n.position.append)t=n.position.append,e="append";else if(null!==n.position.prepend)t=n.position.prepend,e="prepend";else if(null!==n.position.replace)t=n.position.replace,e="replaceWith";else if(null!==n.position.externalRender)return void this._applyExternalRender(n,i,function(e){r(e,{error:!1,externalRendering:!0})});var a,o=this._determineSelector(t);null===o?r(null,{error:!0,errorDescription:"unable to find anchor",externalRendering:!1}):null===(a=this._determineSelector(n.templates.container))?r(null,{error:!0,errorDescription:"unable to find container",externalRendering:!1}):(this._replacePlaceholders(a,i,n),u.isFunction(o[e])?(o[e](a),r(a,{error:!1,externalRendering:!1})):r(null,{error:!0,errorDescription:"unable to apply method to anchor",externalRendering:!1}))}else r(null,{error:!0,errorDescription:"missing position",externalRendering:!1})},_applyExternalRender:function(e,t,n){u.isFunction(e.position.externalRender)?e.position.externalRender(t,n):n(null)},_appendItems:function(i,e,r){let a=this,o=this._determineSelector(r.templates.item);if(null===o)return null;u.each(e.recommendations,function(e,t){var n=a._replacePlaceholders(o.clone(!1),t,r);a._setupItemData(n,e,u.extend(!0,{widgetPosition:e<0?e:e+1},t)),i.append(n),l._process(r.process.attachedItem,i,n,t,r)})},_isItem:function(e){return 1!==e.closest("[data-"+l.marker.container+'="true"]').length},_setupItemData:function(e,t,n){e.addClass(this.marker.item).attr("data-"+this.marker.item,"true").data(this.marker.data,n)},_replacePlaceholders:function(i,r,a){let o=this;i.contents().filter(function(){return 3===this.nodeType}).each(function(){var e=u(this),t=o._replace(e.text(),r,a);null!==t&&e.replaceWith(t)});var e=i.get(0).attributes;return u.each(e,function(e,t){var n=o._replace(t.value,r,a);null!==n&&(t.name.startsWith("data-rename-")?(i.removeAttr(t.name),i.attr(t.name.replace("data-rename-",""),n)):i.attr(t.name,n))}),i.children().each(function(){o._replacePlaceholders(u(this),r,a)}),i},_replace:function(e,s,l){var c=this;if("string"!=typeof e||""===e.trim())return null;let d={_counter:0};e=e.replace(/%%([a-zA-Z][a-zA-Z0-9_]*(?:\.[a-zA-Z](?:(?:::)?[a-zA-Z0-9_])*)*|[a-zA-Z][a-zA-Z0-9_-]*(?:::[a-zA-Z][a-zA-Z0-9_-]*)?)%%/g,function(e,t){var n=l.placeholders[t],i=u.isFunction(n)||"string"==typeof n,r=c._readPath(t,s),a=void 0!==r;let o;return null===(o=null===(o=i?"string"==typeof n?n:u.isFunction(n)?n.call(l.placeholders,s,a?r:null):null:a?r:null)&&u.isFunction(l.placeholderSettings.replaceWith)?l.placeholderSettings.replaceWith(t):o)?e:(d._counter++,o)});return 0<d._counter?e:null},_readPath:function(e,t){var n=e.split(".");if(1===n.length)return t[e];let i=t;for(let e=0;e<n.length;e++){if(!u.isPlainObject(i))return null;var r=n[e];i=i[r]}return i}},a={recommender:null,activity:{type:"clickedRecommendation"},bindings:{selector:"a",specificSelectors:{}},splitTests:{control:{containerSelector:null}},position:{before:null,after:null,prepend:null,append:null,replace:null,externalRender:null},placeholderSettings:{replaceWith:function(e){return""}},placeholders:{"random::uuid":function(){return Breinify.UTL.uuid()},"marker::container":l.marker.container,"marker::item":l.marker.item},templates:{container:null,item:null},process:{stoppedPropagation:function(e){},error:function(e){},init:function(e){},pre:function(e,t){},attachedContainer:function(e,t,n,i){},attachedItem:function(e,t,n,i){},attached:function(e,t,n,i){},post:function(e,t,n,i){},clickedItem:function(e,t){},createActivity:function(e,t){}},data:{modify:function(e,t){return null}}};var t={marker:u.extend(!0,{},l.marker),bind:function(){let r=this;e.overload({"Object,Object":function(e,t){let i=u.extend(!0,{},a,renderOption);r._loadSplitTestSeparately(e,function(e,t){var t=r._mapResult({additionalData:{splitTestData:t},statusCode:200}),n=this._determineSelector(i.templates.container);r._setupContainer(n,i,t),r._applyBindings(i,n)})}},arguments,this)},render:function(){let s=this;e.overload({Array:function(t){let n={};var i=[];for(let e=0;e<t.length;e++){var r=this._preRenderRecommendations({temporary:t[e]}),a=r.temporary.recommender;if(!u.isPlainObject(a)||!u.isPlainObject(a.payload)||!u.isArray(a.payload.namedRecommendations))return void l._process(r.process.error,{code:-1,error:!0,message:"invalid payload for recommender defined for rendering process",options:r});var o=this._determineName(a.payload,e);n[o]=r.temporary,i.push(a.payload)}this._retrieveRecommendations(i,function(e,t){s._renderRecommendations(n,e,t)})},Object:function(e){s.render([e])},"Object,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations([e],function(e,t){s._renderRecommendations(n,e,t)})},"Array,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations(null,e,function(e,t){s._renderRecommendations(n,e,t)})},"String,Object":function(e,t){let n=this._preRenderRecommendations(t);this._retrieveRecommendations([{namedRecommendations:[e]}],function(e,t){s._renderRecommendations(n,e,t)})},"String,Object,Object":function(e,t,n){let i=this._preRenderRecommendations(n);this._retrieveRecommendations([u.extend({namedRecommendations:[e]},t)],function(e,t){s._renderRecommendations(i,e,t)})}},arguments,this)},get:function(){e.overload({"Object,Function":function(e,t){this._retrieveRecommendations([e],t)},"Array,Function":function(e,t){this._retrieveRecommendations(e,t)},"String,Function":function(e,t){this._retrieveRecommendations([{namedRecommendations:[e]}],t)},"String,Object,Function":function(e,t,n){this._retrieveRecommendations([u.extend({namedRecommendations:[e]},t)],n)}},arguments,this)},setRecommendationData:function(e,t,n){return!!l._isItem(e)&&(l._setupItemData(e,t,n),!0)},_loadSplitTestSeparately:function(e,n){var t=e.name,i=null===Breinify.UTL.isNonEmptyString(e.token)?e.tokens:e.token,r=null===Breinify.UTL.isNonEmptyString(e.storageKey)?e.storageKeys:e.storageKey,e=u.extend(!0,{splitTestName:e.name},e.payload);Breinify.plugins.splitTests.retrieveSplitTest(t,i,e,r,function(e,t){n(e,t)})},_preRenderRecommendations:function(e){let n={};return u.each(e,function(e,t){t=u.extend(!0,{},a,t);l._process(t.process.init,t),n[e]=t}),n},_renderRecommendations:function(e,n,t){let a=this;null!==n?u.each(e,function(e,t){l._process(t.process.error,n)}):u.each(e,function(e,i){let r=t[e];if(u.isPlainObject(r)&&u.isPlainObject(r.status))if(!0===r.status.error)l._process(i.process.error,u.extend({name:e,result:r},r.status));else if(u.isFunction(i.data.modify)){let t=function(t){u.isArray(t)||(t=u.isPlainObject(t)&&u.isPlainObject(t.result)&&u.isPlainObject(t.option)?[t]:[{result:r,option:i}]);for(let e=0;e<t.length;e++){var n=t[e];a._applyRecommendation(n.result,n.option)}};var n=i.data.modify(r,i);u.isFunction(i.data.modify.constructor)&&"AsyncFunction"===i.data.modify.constructor.name&&window.Promise&&n instanceof window.Promise?n.then(e=>t(e)).catch(e=>l._process(i.process.error,{code:-1,error:!0,message:e.message,name:e.name,result:e})):t(n)}else a._applyRecommendation(r,i);else l._process(i.process.error,{code:-1,error:!0,message:"unexpected result-type received",name:e,result:r})})},_applyRecommendation:function(e,t){let n=this;var i;!0===e.splitTestData.isControl?(i=n._setupControlContainer(t,e),this._applyBindings(t,i)):7120!==e.status.code&&this._renderRecommendation(t,e,function(e){n._applyBindings(t,e)})},_handleClick:function(e,t,n,i){var r,a=t.closest("."+l.marker.container);1===a.length&&(r=a.data(l.marker.data),u.isPlainObject(r))&&u.isPlainObject(r.option)&&u.isPlainObject(r.data)&&(!0===r.data.splitTestData.isControl?this._handleControlClick(n,t,a,r.data,i,r.option):this._handleRecommendationClick(n,t,a,r.data,i,r.option),!0===i.stopPropagation)&&(n.stopPropagation(),l._process(e.process.stoppedPropagation,n,t,a,r.data,i,r.option))},_handleRecommendationClick:function(e,t,n,i,r,a){var o,t=t.closest("."+l.marker.item);1===t.length&&(o=t.data(l.marker.data),u.isPlainObject(o))&&(t={isControl:!1,$recItem:t,$recContainer:n,additionalEventData:r,recommendationData:i,recommendation:o},l._process(a.process.clickedItem,e,t),n=this._createDefaultTags(i,r),this._applyBreinifyTags(n,i,o,r),t.activityTags=n,this._sendActivity(a,e,t))},_handleControlClick:function(e,t,n,i,r,a){t={isControl:!0,$controlItem:t,$controlContainer:n,additionalEventData:r,recommendationData:i};l._process(a.process.clickedItem,e,t),t.activityTags=this._createDefaultTags(i,r),this._sendActivity(a,e,t)},_applyBreinifyTags:function(e,t,n,i){"number"==typeof n.widgetPosition&&(e.widgetPosition=n.widgetPosition,"string"==typeof e.widgetType)&&(e.widgetId=e.widgetType+"-"+e.widgetPosition),e.productIds=[],"string"==typeof n.id&&e.productIds.push(n.id)},_createDefaultTags:function(e,t){var n={},i=u.isPlainObject(e.splitTestData)?e.splitTestData:{active:!1};let r,a;a=!1===i.active?(r=l.splitTest.defaultGroupType,l.splitTest.defaultGroup):!0===i.isControl?(r=l.splitTest.controlGroupType,"string"==typeof i.groupDecision&&""!==i.groupDecision.trim()?i.groupDecision:l.splitTest.defaultControlGroup):(r=l.splitTest.testGroupType,"string"==typeof i.groupDecision&&""!==i.groupDecision.trim()?i.groupDecision:l.splitTest.defaultTestGroup);var o="string"==typeof i.testName&&""!==i.testName.trim()?i.testName:null,i="string"==typeof i.selectedInstance&&""!==i.selectedInstance.trim()?i.selectedInstance:null,o=(n.group=a,n.groupType=r,n.splitTest=null===o?null:o+(null===i?"":" ("+i+")"),u.isPlainObject(e.payload)?e.payload:{}),i="string"==typeof o.queryName&&""!==o.queryName.trim()?o.queryName:null,e="string"==typeof o.recommenderName&&""!==o.recommenderName.trim()?o.recommenderName:null;return n.widgetType=e,n.widgetLabel=null===i?e:i,n},_sendActivity:function(e,t,n){var i=t.metaKey||t.ctrlKey||2===t.which,r=t.target instanceof HTMLAnchorElement,a=e.activity.type;if(n=u.extend(!0,{additionalEventData:{meta:{openInNewTab:i,willReloadPage:r},sendActivities:!0,scheduleActivities:null},activityType:a,activityTags:{},activityUser:{}},n),l._process(e.process.createActivity,t,n),!1!==n.additionalEventData.sendActivities){"number"==typeof n.activityTags.widgetPosition&&"string"==typeof n.activityTags.widgetType&&"string"!=typeof n.activityTags.widgetId&&(n.activityTags.widgetId=n.activityTags.widgetType+"-"+n.activityTags.widgetPosition);let e=null;null===n.additionalEventData.scheduleActivities?e=!1!=r&&!0!==i:"boolean"==typeof n.additionalEventData.scheduleActivities&&(e=n.additionalEventData.scheduleActivities),u.isPlainObject(Breinify.plugins.activities)&&(!0===e?Breinify.plugins.activities.scheduleDelayedActivity(n.activityUser,n.activityType,n.activityTags,6e4):!1===e&&Breinify.plugins.activities.generic(n.activityType,n.activityUser,n.activityTags))}},_applyBindings:function(n,i){let r=this;Breinify.UTL.dom.addClickObserver(n.bindings.selector,"clickedRecommendations",function(e,t){r._handleClick(n,u(this),e,t)});var a=n.bindings.specificSelectors;if(u.isPlainObject(a)&&null!==i){var o=Object.keys(a);for(let e=0;e<o.length;e++){var s=o[e],l=a[s];let t=u.isPlainObject(l)?l:{};i.find(s).on("click",function(e){r._handleClick(n,u(this),e,t)})}}},_setupControlContainer:function(e,t){var n=l._determineSelector(e.splitTests.control.containerSelector);return null===n?null:this._setupContainer(n,e,t)},_setupContainer:function(e,t,n){return e.hasClass(l.marker.container)||e.addClass(l.marker.container),e.attr("data-"+l.marker.container,"true").data(l.marker.data,{option:t,data:n})},_renderRecommendation:function(r,a,o){let s=this;l._process(r.process.pre,a,r),l._appendContainer(r,a,function(e,t){if(null===e||!0===t.error)o(null,t);else{let i=e.find("."+l.marker.container);0===i.length&&(i=e).addClass(l.marker.container),i=s._setupContainer(i,r,a),l._process(r.process.attachedContainer,e,i,a,r),!0===t.externalRendering?u.each(a.recommendations,function(e,t){var n=i.children().eq(e);l._setupItemData(n,e,u.extend(!0,{widgetPosition:e<0?e:e+1},t))}):(l._appendItems(i,a,r),l._process(r.process.attached,e,i,a,r));var n=l._determineSelector(r.splitTests.control.containerSelector);null!==n&&1===n.length&&n.get(0)!==e.get(0)&&0===n.find(".brrc-item").length&&n.hide(),l._process(r.process.post,e,i,a,r),o(e,t)}})},_retrieveRecommendations:function(n,i){let r=this;Breinify.recommendation({},n,function(e,t){"string"==typeof t?i(new Error(t)):u.isArray(e.results)?(t=r._mapResults(n,e.results),i(null,t)):i(new Error("Invalid response received."))})},_mapResult:function(e){var t={};return this._determineErrorResponse(e,t)||this._determineSplitTestData(e,t)||this._determineRecommendationData(e,t),this._determineAdditionalData(e,t),this._determineMetaData(e,t),t},_mapResults:function(r,a){var o={};for(let i=0;i<a.length;i++){var s=i<r.length&&u.isPlainObject(r[i])?r[i]:{},l=a[i],l=this._mapResult(l),c=this._determineName(s,i);let e=null,t=("number"==typeof s.numRecommendations&&0<s.numRecommendations&&(e=s.numRecommendations),null),n=("string"==typeof s.recommendationQueryName&&""!==s.recommendationQueryName.trim()&&(t=s.recommendationQueryName),null);u.isPlainObject(s)&&u.isArray(s.namedRecommendations)&&1===s.namedRecommendations.length&&(n=s.namedRecommendations[0]);s=u.isArray(s.recommendationForItems)&&0<s.recommendationForItems.length;l.payload={name:c,recommenderName:n,queryName:t,isForItems:s,expectedNumberOfRecommendations:e},o[c]=l}return o},_determineErrorResponse:function(e,t){return u.isPlainObject(e)?(200===e.statusCode||7120===e.statusCode?t.status={code:e.statusCode,message:e.message,error:!1}:t.status={error:!0,code:e.statusCode,message:e.message},t.status.error):(t.status={error:!0,code:500,message:"invalid result type received"},!0)},_determineRecommendationType:function(e){let t="com.brein.common.dto.CustomerProductDto";return t=u.isPlainObject(e)&&u.isPlainObject(e._breinMetaData)&&"string"==typeof e._breinMetaData.dataType&&""!==e._breinMetaData.dataType.trim()?e._breinMetaData.dataType.trim():t},_determineRecommendationData:function(e,t){var n=this._determineRecommendationType(e);t.recommendations="com.brein.common.dto.CustomerProductDto"===n?this._mapProducts(e):this._mapAny(e)},_determineAdditionalData:function(e,n){u.isPlainObject(e)&&u.isPlainObject(e.additionalData)&&(n.additionalData={},u.each(e.additionalData,function(e,t){"_breinMetaData"!==e&&"splitTestData"!==e&&(n.additionalData[e]=t)}))},_determineName:function(e,t){return u.isPlainObject(e)&&u.isArray(e.namedRecommendations)&&1===e.namedRecommendations.length?e.namedRecommendations[0]:"response["+t+"]"},_determineMetaData:function(e,t){t.meta={},t.meta.type=this._determineRecommendationType(e)},_determineSplitTestData:function(e,t){return u.isPlainObject(e)&&u.isPlainObject(e.additionalData)&&u.isPlainObject(e.additionalData.splitTestData)?t.splitTestData=u.extend({active:!0,isTest:200===e.statusCode,isControl:7120===e.statusCode},e.additionalData.splitTestData):7120===e.statusCode?t.splitTestData={active:!0,isTest:!1,isControl:!1}:t.splitTestData={active:!1,isTest:!1,isControl:!1},t.active},_mapProducts:function(e){if(!u.isArray(e.result))return[];for(var t=[],n=0;n<e.result.length;n++){var i=e.result[n],i=this._mapProduct(i);t.push(i)}return t},_mapProduct:function(e){var t;return u.isPlainObject(e)&&"string"==typeof e.dataIdExternal&&u.isPlainObject(e.additionalData)?(t=null===(t=this._getValue(e,"inventory::productPrice"))?this._getValue(e,"product::productPrice"):t,{_recommenderWeight:e.weight,id:e.dataIdExternal,inventory:this._getValue(e,"inventory::inventoryQuantity"),name:this._getValue(e,"product::productName"),url:this._getValue(e,"product::productUrl"),image:this._getValue(e,"product::productImageUrl"),categories:this._getValue(e,"product::productCategories"),description:this._getValue(e,"product::productDescription"),price:t,additionalData:e.additionalData}):null},_mapAny:function(e){if(!u.isArray(e.result))return[];for(var t=[],n=0;n<e.result.length;n++){var i=e.result[n],i={_recommenderWeight:i.weight,id:i.dataIdExternal,additionalData:i.additionalData};t.push(i)}return t},_getValue:function(e,t){e=e.additionalData[t];return null==e?null:e}};Breinify.plugins._add("recommendations",t)}})();