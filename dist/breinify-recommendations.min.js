"use strict";!function(){if("object"==typeof Breinify){var a=Breinify.UTL._jquery(),b=Breinify.plugins._overload(),c=(Breinify.UTL.constants.errors.prefix.validation,Breinify.UTL.constants.errors.prefix.api,{get:function(){b.overload({"String,Number,Function":function(a,b,c){this._retrieveRecommendations([a],{},b,{},c)},"Array,Number,Function":function(a,b,c){this._retrieveRecommendations(a,{},b,{},c)},"String,Number,Object,Function":function(a,b,c,d){this._retrieveRecommendations([a],{},b,c,d)},"Array,Number,Object,Function":function(a,b,c,d){this._retrieveRecommendations(a,{},b,c,d)},"String,Object,Number,Function":function(a,b,c,d){this._retrieveRecommendations([a],b,c,{},d)},"Array,Object,Number,Function":function(a,b,c,d){this._retrieveRecommendations(a,b,c,{},d)},"String,Object,Number,Object,Function":function(a,b,c,d,e){this._retrieveRecommendations([a],b,c,d,e)},"Array,Object,Number,Object,Function":function(a,b,c,d,e){this._retrieveRecommendations(a,b,c,d,e)}},arguments,this)},_retrieveRecommendations:function(b,c,d,e,f){var g=this,h=this._createUser(c,e),i=this._createRecommendations(b,d);return a.isPlainObject(i)&&a.isArray(i.payload)&&0!==i.payload.length?void Breinify.recommendation(h,i.payload,function(b,c){if("string"==typeof c)f(new Error(c));else if(a.isArray(b.results)){var e=g._mapResults(i,b.results);e=g._applyRecommendationSettings(d,i,e),f(null,e)}else f(new Error("Invalid response received."))}):void f(null,{})},_getSettings:function(b){var c=this.getConfig("recommendationSettings",{}),d=c[b];return a.isPlainObject(d)?d:{}},_getPayload:function(b){var c=this.getConfig("recommendationPayloads",{}),d=c[b];return a.isPlainObject(d)?d:{}},_applyRecommendationSettings:function(b,c,d){for(var e={},f=[],g=0;g<c.recommendationIds.length;g++){for(var h=c.recommendationIds[g],i=this._getSettings(h),j=i.filter,k="boolean"!=typeof i.removeDuplicates||i.removeDuplicates,l=a.isArray(i.recommendationPayloadId)?i.recommendationPayloadId:[i.recommendationPayloadId],m=[],n=[],o=0;o<l.length&&n.length<b;o++){var p=d[l[o]],q=this._applyRecommendationPayload(p,j,m);k&&(q=this._removeUsedProducts(f,q)),n=n.concat(q).slice(0,b)}for(var r=0;r<n.length;r++)f.push(n[r].dataIdExternal);e[h]=n}return e},_applyRecommendationPayload:function(b,c,d){if(!a.isArray(b))return[];b=this._removeUsedProducts(d,b),a.isFunction(c)&&(b=c(b));for(var e=0;e<b.length;e++)d.push(b[e].dataIdExternal);return b},_removeUsedProducts:function(b,c){if(!a.isArray(c))return[];for(var d=[],e=0;e<c.length;e++){var f=c[e];a.inArray(f.dataIdExternal,b)===-1&&d.push(f)}return d},_createRecommendations:function(b,c){var d={payload:[],recommendationsPayloadIds:[],payloadIdToRecommendationIds:{},recommendationIds:{}};if(!a.isArray(b))return d;for(var e=[],f={},g=[],h=0;h<b.length;h++){var i=b[h],j=this._getSettings(i);if(a.isPlainObject(j))for(var k=a.isArray(j.recommendationPayloadId)?j.recommendationPayloadId:[j.recommendationPayloadId],l=0;l<k.length;l++){var m=k[l];a.inArray(m,e)===-1&&e.push(m);var n=f[m];a.isArray(n)||(n=[],f[m]=n),a.inArray(i,n)===-1&&n.push(i),a.inArray(i,g)===-1&&g.push(i)}}if(0===e.length)return d;for(var o=0;o<e.length;o++){var p=e[o],q=this._getPayload(p);if(a.isPlainObject(q)){q=a.extend({},q);var r=q.multiplier;r="number"==typeof r?Math.max(r,1):1,q.numRecommendations=r*c,d.recommendationsPayloadIds.push(p),d.payload.push(q)}}return d.payloadIdToRecommendationIds=f,d.recommendationIds=g,d},_createUser:function(b,c){var d={additional:{}};return a.isPlainObject(b)&&(d.userId="string"==typeof b.userId&&""!==b.userId.trim()?b.userId:null,d.email="string"==typeof b.email&&""!==b.email.trim()?b.email.toLowerCase():null),a.isPlainObject(c)&&(d.additional.location={storeId:"string"==typeof c.storeId&&""!==c.storeId.trim()?c.storeId:null}),d},_mapResults:function(b,c){for(var d={},e=0;e<c.length;e++){var f=c[e].result,g=a.isPlainObject(f[e].additionalData)?f[e].additionalData:{},h=[];if(a.isArray(f))for(var i=0;i<f.length;i++){var j=this._mapProduct(f[i],g);a.isPlainObject(j)&&h.push(j)}var k=b.recommendationsPayloadIds[e];d[k]=h}return d},_mapProduct:function(b,c){if(!a.isPlainObject(b)||"string"!=typeof b.dataIdExternal)return null;if(!a.isPlainObject(b.additionalData))return null;var d=this.getConfig("mapProduct",function(a,b){return{dataIdExternal:a.dataIdExternal,sku:a.dataIdExternal,inventory:a.additionalData["inventory::inventoryQuantity"],price:a.additionalData["inventory::productPrice"],name:a.additionalData["product::productName"],url:a.additionalData["product::productUrl"],image:a.additionalData["product::productImageUrl"],description:a.additionalData["product::productDescription"],additionalData:b}});return d(b)}});Breinify.plugins._add("recommendations",c)}}();